# å¤šæ™ºèƒ½ä½“ç³»ç»Ÿå·¥ä½œæµç¨‹æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è¿°](#ç³»ç»Ÿæ¶æ„æ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#æ ¸å¿ƒç»„ä»¶è¯¦è§£)
3. [å®Œæ•´å·¥ä½œæµç¨‹](#å®Œæ•´å·¥ä½œæµç¨‹)
4. [æ™ºèƒ½ä½“åä½œæœºåˆ¶](#æ™ºèƒ½ä½“åä½œæœºåˆ¶)
5. [é”™è¯¯å¤„ç†æµç¨‹](#é”™è¯¯å¤„ç†æµç¨‹)
6. [æ—¶é—´æ„ŸçŸ¥é›†æˆ](#æ—¶é—´æ„ŸçŸ¥é›†æˆ)
7. [é…ç½®ç³»ç»Ÿ](#é…ç½®ç³»ç»Ÿ)
8. [æ—¥å¿—å’Œè°ƒè¯•](#æ—¥å¿—å’Œè°ƒè¯•)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è¿°

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OrchestraAgent                           â”‚
â”‚                   (æ ¸å¿ƒåè°ƒå™¨)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚PlannerAgent â”‚  â”‚WorkerAgents â”‚  â”‚ReporterAgentâ”‚           â”‚
â”‚  â”‚  (ä»»åŠ¡è§„åˆ’)  â”‚  â”‚ (ä»»åŠ¡æ‰§è¡Œ)  â”‚  â”‚ (æŠ¥å‘Šç”Ÿæˆ)  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚               â”‚               â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                         â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            å·¥å…·åŒ…ç³»ç»Ÿ (Toolkits)                      â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚Datetime  â”‚ â”‚AKShare   â”‚ â”‚Financial â”‚ â”‚Report   â”‚ â”‚   â”‚
â”‚  â”‚ â”‚Toolkit   â”‚ â”‚Tool      â”‚ â”‚Analysis  â”‚ â”‚Saver    â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **åˆ†å±‚æ¶æ„**: åè°ƒå±‚ + æ‰§è¡Œå±‚ + å·¥å…·å±‚
2. **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªæ™ºèƒ½ä½“èŒè´£å•ä¸€ï¼Œå¯ç‹¬ç«‹æ›¿æ¢
3. **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶è¡Œä¸º
4. **æµå¼å¤„ç†**: æ”¯æŒå®æ—¶è¾“å‡ºå’ŒçŠ¶æ€æ›´æ–°
5. **æ—¶é—´æ„ŸçŸ¥**: å†…ç½®æ—¶é—´åˆ¤æ–­å’Œæ•°æ®å¯ç”¨æ€§æ£€æŸ¥

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. OrchestraAgent (æ ¸å¿ƒåè°ƒå™¨)

**ä½ç½®**: `utu/agents/orchestra_agent.py`

**èŒè´£**:
- åˆå§‹åŒ–å’Œç®¡ç†æ‰€æœ‰å­æ™ºèƒ½ä½“
- åè°ƒä»»åŠ¡æ‰§è¡Œæµç¨‹
- ç®¡ç†ä»»åŠ¡è®°å½•å™¨
- å¤„ç†æµå¼è¾“å‡º

**å…³é”®æ–¹æ³•**:
```python
async def run(input: str, trace_id: str = None) -> OrchestraTaskRecorder
def run_streamed(input: str, trace_id: str = None) -> OrchestraTaskRecorder
async def build()  # åˆå§‹åŒ–æ‰€æœ‰å­æ™ºèƒ½ä½“
```

**å·¥ä½œæµç¨‹**:
1. åˆå§‹åŒ– â†’ 2. è®¡åˆ’åˆ¶å®š â†’ 3. ä»»åŠ¡æ‰§è¡Œ â†’ 4. ç»“æœæŠ¥å‘Š

### 2. PlannerAgent (ä»»åŠ¡è§„åˆ’å™¨)

**ä½ç½®**: `utu/agents/orchestra/planner.py`

**èŒè´£**:
- åˆ†æç”¨æˆ·è¯·æ±‚
- åˆ¶å®šæ‰§è¡Œè®¡åˆ’
- åˆ†é…ä»»åŠ¡ç»™åˆé€‚çš„Workeræ™ºèƒ½ä½“
- ç®¡ç†ç¤ºä¾‹æ•°æ®

**æ ¸å¿ƒåŠŸèƒ½**:
```python
async def create_plan(task_recorder: OrchestraTaskRecorder) -> CreatePlanResult
```

**è¾“å‡ºè§£æå™¨**:
- åˆ†æé˜¶æ®µ: `<analysis>...</analysis>`
- è®¡åˆ’é˜¶æ®µ: `<plan>[...]</plan>`
- ä»»åŠ¡æ ¼å¼: `{"agent_name": "...", "task": "...", "completed": false}`

### 3. WorkerAgents (ä»»åŠ¡æ‰§è¡Œå™¨)

**ä½ç½®**: `utu/agents/orchestra/worker.py`

**ç±»å‹**:
- **DataAgent**: è´¢åŠ¡æ•°æ®è·å–ä¸“å®¶
- **DataAnalysisAgent**: æ•°æ®åˆ†æä¸“å®¶
- **FinancialAnalysisAgent**: è´¢åŠ¡åˆ†æä¸“å®¶
- **ChartGeneratorAgent**: å›¾è¡¨ç”Ÿæˆä¸“å®¶
- **ReportAgent**: æŠ¥å‘Šç”Ÿæˆä¸“å®¶

**å·¥ä½œæ¨¡å¼**:
```python
async def work(task_recorder: OrchestraTaskRecorder, subtask: Subtask) -> WorkerResult
def work_streamed(task_recorder: OrchestraTaskRecorder, subtask: Subtask) -> WorkerResult
```

### 4. ReporterAgent (æŠ¥å‘Šç”Ÿæˆå™¨)

**ä½ç½®**: `utu/agents/orchestra/reporter.py`

**èŒè´£**:
- æ•´åˆæ‰€æœ‰æ‰§è¡Œç»“æœ
- ç”Ÿæˆæœ€ç»ˆåˆ†ææŠ¥å‘Š
- æ ¼å¼åŒ–è¾“å‡ºå†…å®¹

**æ ¸å¿ƒåŠŸèƒ½**:
```python
async def report(task_recorder: OrchestraTaskRecorder) -> AnalysisResult
```

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### é˜¶æ®µ1: ç³»ç»Ÿåˆå§‹åŒ–

```mermaid
graph TD
    A[ç”¨æˆ·å¯åŠ¨] --> B[åŠ è½½é…ç½®æ–‡ä»¶]
    B --> C[åˆ›å»ºOrchestraAgent]
    C --> D[åˆå§‹åŒ–PlannerAgent]
    D --> E[åˆå§‹åŒ–WorkerAgents]
    E --> F[åˆå§‹åŒ–ReporterAgent]
    F --> G[åŠ è½½å·¥å…·åŒ…]
    G --> H[ç³»ç»Ÿå°±ç»ª]
```

**è¯¦ç»†æ­¥éª¤**:
1. **é…ç½®åŠ è½½**: ä»YAMLæ–‡ä»¶åŠ è½½æ™ºèƒ½ä½“é…ç½®
2. **æ™ºèƒ½ä½“åˆ›å»º**: æ ¹æ®é…ç½®åˆ›å»ºå„ä¸ªå­æ™ºèƒ½ä½“
3. **å·¥å…·åŒ…é›†æˆ**: åŠ è½½å¹¶é…ç½®æ‰€æœ‰å·¥å…·åŒ…
4. **è¿æ¥å»ºç«‹**: å»ºç«‹æ™ºèƒ½ä½“é—´çš„é€šä¿¡è¿æ¥

### é˜¶æ®µ2: ä»»åŠ¡è§„åˆ’

```mermaid
graph TD
    A[æ¥æ”¶ç”¨æˆ·è¯·æ±‚] --> B[PlannerAgentåˆ†æ]
    B --> C[åŠ è½½ç¤ºä¾‹æ•°æ®]
    C --> D[ç”Ÿæˆåˆ†æå†…å®¹]
    D --> E[åˆ¶å®šæ‰§è¡Œè®¡åˆ’]
    E --> F[åˆ†é…Workeræ™ºèƒ½ä½“]
    F --> G[è¾“å‡ºè®¡åˆ’ç»“æœ]
```

**PlannerAgentå¤„ç†æµç¨‹**:
1. **è¯·æ±‚åˆ†æ**: è§£æç”¨æˆ·éœ€æ±‚å’Œä¸Šä¸‹æ–‡
2. **ç¤ºä¾‹åŒ¹é…**: ä»ç¤ºä¾‹åº“ä¸­åŒ¹é…ç›¸ä¼¼åœºæ™¯
3. **æ™ºèƒ½ä½“é€‰æ‹©**: æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©åˆé€‚çš„Worker
4. **è®¡åˆ’ç”Ÿæˆ**: åˆ›å»ºç»“æ„åŒ–çš„ä»»åŠ¡åˆ—è¡¨
5. **æ—¶é—´æ£€æŸ¥**: éªŒè¯æ•°æ®å¯ç”¨æ€§å’Œæ—¶é—´åˆç†æ€§

### é˜¶æ®µ3: ä»»åŠ¡æ‰§è¡Œ

```mermaid
graph TD
    A[æ¥æ”¶æ‰§è¡Œè®¡åˆ’] --> B[æŒ‰é¡ºåºæ‰§è¡Œä»»åŠ¡]
    B --> C{ä»»åŠ¡ç±»å‹åˆ¤æ–­}
    C -->|DataAgent| D[è·å–è´¢åŠ¡æ•°æ®]
    C -->|DataAnalysisAgent| E[æ‰§è¡Œæ•°æ®åˆ†æ]
    C -->|FinancialAnalysisAgent| F[è¿›è¡Œä¸“ä¸šåˆ†æ]
    C -->|ChartGeneratorAgent| G[ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨]
    C -->|ReportAgent| H[ç”Ÿæˆåˆ†ææŠ¥å‘Š]
    D --> I[è®°å½•æ‰§è¡Œç»“æœ]
    E --> I
    F --> I
    G --> I
    H --> I
    I --> J{è¿˜æœ‰ä»»åŠ¡?}
    J -->|æ˜¯| C
    J -->|å¦| K[æ‰§è¡Œå®Œæˆ]
```

**æ¯ä¸ªWorkerçš„æ‰§è¡Œæµç¨‹**:
1. **ä»»åŠ¡æ¥æ”¶**: è·å–åˆ†é…çš„å…·ä½“ä»»åŠ¡
2. **ä¸Šä¸‹æ–‡æ„å»º**: æ•´åˆä¹‹å‰çš„æ‰§è¡Œç»“æœ
3. **å·¥å…·è°ƒç”¨**: ä½¿ç”¨ç›¸åº”çš„å·¥å…·åŒ…å®Œæˆä»»åŠ¡
4. **ç»“æœè®°å½•**: ä¿å­˜æ‰§è¡Œç»“æœå’Œè½¨è¿¹
5. **çŠ¶æ€æ›´æ–°**: æ›´æ–°ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€

### é˜¶æ®µ4: ç»“æœæŠ¥å‘Š

```mermaid
graph TD
    A[æ”¶é›†æ‰€æœ‰æ‰§è¡Œç»“æœ] --> B[ReporterAgentå¤„ç†]
    B --> C[æ•´åˆåˆ†æå†…å®¹]
    C --> D[ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š]
    D --> E[æ ¼å¼åŒ–è¾“å‡º]
    E --> F[ä¿å­˜ç»“æœæ–‡ä»¶]
    F --> G[è¿”å›ç»™ç”¨æˆ·]
```

## ğŸ¤ æ™ºèƒ½ä½“åä½œæœºåˆ¶

### æ•°æ®ä¼ é€’æœºåˆ¶

```python
class OrchestraTaskRecorder:
    plan: CreatePlanResult           # æ‰§è¡Œè®¡åˆ’
    task_records: list[WorkerResult] # ä»»åŠ¡æ‰§è¡Œè®°å½•
    trajectories: list[dict]         # æ‰§è¡Œè½¨è¿¹
    final_output: str               # æœ€ç»ˆè¾“å‡º
```

### çŠ¶æ€åŒæ­¥

1. **ä»»åŠ¡çŠ¶æ€**: æ¯ä¸ªSubtaskåŒ…å«completedçŠ¶æ€
2. **æ‰§è¡Œè½¨è¿¹**: è®°å½•æ¯ä¸ªæ™ºèƒ½ä½“çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹
3. **ç»“æœèšåˆ**: é€æ­¥æ„å»ºæœ€ç»ˆçš„åˆ†æç»“æœ

### é”™è¯¯ä¼ æ’­

```python
# é”™è¯¯å¤„ç†æµç¨‹
try:
    result = await agent.work(task_recorder, subtask)
except Exception as e:
    # è®°å½•é”™è¯¯ä¿¡æ¯
    error_info = {
        "agent": subtask.agent_name,
        "task": subtask.task,
        "error": str(e),
        "traceback": traceback.format_exc()
    }
    # å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œæˆ–ç»ˆæ­¢
```

## âš ï¸ é”™è¯¯å¤„ç†æµç¨‹

### é”™è¯¯åˆ†ç±»

1. **é…ç½®é”™è¯¯**: æ™ºèƒ½ä½“é…ç½®é—®é¢˜
2. **å·¥å…·é”™è¯¯**: å·¥å…·åŒ…è°ƒç”¨å¤±è´¥
3. **æ•°æ®é”™è¯¯**: æ•°æ®è·å–æˆ–å¤„ç†å¤±è´¥
4. **ç½‘ç»œé”™è¯¯**: APIè°ƒç”¨è¶…æ—¶æˆ–å¤±è´¥
5. **é€»è¾‘é”™è¯¯**: æ™ºèƒ½ä½“æ¨ç†é”™è¯¯

### é”™è¯¯å¤„ç†ç­–ç•¥

```python
class ErrorHandler:
    def handle_error(self, error: Exception, context: dict) -> ErrorAction:
        # 1. è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
        self.log_error(error, context)

        # 2. åˆ†æé”™è¯¯ç±»å‹
        error_type = self.classify_error(error)

        # 3. å†³å®šå¤„ç†ç­–ç•¥
        if error_type == "recoverable":
            return ErrorAction.RETRY
        elif error_type == "skipable":
            return ErrorAction.SKIP
        else:
            return ErrorAction.ABORT
```

### æ¢å¤æœºåˆ¶

1. **è‡ªåŠ¨é‡è¯•**: å¯¹äºä¸´æ—¶æ€§é”™è¯¯è¿›è¡Œé‡è¯•
2. **é™çº§å¤„ç†**: ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆç»§ç»­æ‰§è¡Œ
3. **éƒ¨åˆ†å®Œæˆ**: å³ä½¿éƒ¨åˆ†ä»»åŠ¡å¤±è´¥ä¹Ÿç”ŸæˆæŠ¥å‘Š
4. **ç”¨æˆ·é€šçŸ¥**: æ¸…æ™°åœ°å‘ŠçŸ¥ç”¨æˆ·é‡åˆ°çš„é—®é¢˜

## ğŸ• æ—¶é—´æ„ŸçŸ¥é›†æˆ

### æ—¶é—´æ„ŸçŸ¥å·¥ä½œæµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B[æ—¶é—´ä¸Šä¸‹æ–‡åˆ†æ]
    B --> C{æ˜¯å¦æœªæ¥æ•°æ®?}
    C -->|æ˜¯| D[è¯†åˆ«æœªæ¥è¯·æ±‚]
    C -->|å¦| E[æ­£å¸¸å¤„ç†]
    D --> F[æä¾›æ›¿ä»£æ–¹æ¡ˆ]
    F --> G[è·å–å¯ç”¨æ•°æ®]
    G --> H[ç»§ç»­åˆ†ææµç¨‹]
    E --> H
```

### æ—¶é—´æ„ŸçŸ¥ç»„ä»¶

1. **DateTimeToolkit**: æ—¶é—´æ£€æŸ¥å’ŒéªŒè¯
2. **AKShareå¢å¼º**: æ•°æ®å¯ç”¨æ€§æ£€æŸ¥
3. **æ™ºèƒ½ä½“é›†æˆ**: æ—¶é—´æ„ŸçŸ¥çš„å·¥ä½œæµç¨‹

### æ—¶é—´æ„ŸçŸ¥ç¤ºä¾‹

**è¾“å…¥**: "åˆ†æ2025å¹´è´µå·èŒ…å°çš„è´¢æŠ¥æ•°æ®"

**å¤„ç†æµç¨‹**:
1. æ£€æµ‹åˆ°"2025å¹´"æ˜¯æœªæ¥æ—¶é—´
2. éªŒè¯2025å¹´è´¢æŠ¥å°šæœªå‘å¸ƒ
3. å»ºè®®ä½¿ç”¨2024å¹´æˆ–æœ€æ–°å¯ç”¨æ•°æ®
4. ç»§ç»­åŸºäºå¯ç”¨æ•°æ®è¿›è¡Œåˆ†æ

## âš™ï¸ é…ç½®ç³»ç»Ÿ

### é…ç½®æ–‡ä»¶ç»“æ„

```
configs/
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ base.yaml              # åŸºç¡€é…ç½®
â”‚   â””â”€â”€ examples/
â”‚       â””â”€â”€ stock_analysis_final.yaml  # è‚¡ç¥¨åˆ†æé…ç½®
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ akshare_financial_data.yaml
â”‚   â”œâ”€â”€ financial_analysis.yaml
â”‚   â”œâ”€â”€ datetime.yaml          # æ—¶é—´å·¥å…·é…ç½®
â”‚   â””â”€â”€ ...
â””â”€â”€ model/
    â””â”€â”€ base.yaml              # æ¨¡å‹é…ç½®
```

### å…³é”®é…ç½®é¡¹

```yaml
# æ™ºèƒ½ä½“é…ç½®
type: orchestra
planner_config:
  examples_path: stock_analysis_examples.json
  max_plan_length: 1000
  enable_context_compression: true

# å·¥å…·åŒ…é…ç½®
toolkits:
  datetime:
    config:
      timezone: "Asia/Shanghai"
      financial_reporting_rules:
        q1_deadline: "04-30"
        q2_deadline: "08-31"
        q3_deadline: "10-31"
        q4_deadline: "04-30"
```

## ğŸ“Š æ—¥å¿—å’Œè°ƒè¯•

### æ—¥å¿—ç³»ç»Ÿæ¶æ„

```python
class OrchestraLogger:
    def __init__(self, config: dict):
        self.log_file = config.get("log_file", "orchestra.log")
        self.log_level = config.get("log_level", "INFO")
        self.format = "json"  # ç»“æ„åŒ–JSONæ ¼å¼

    def log_agent_event(self, agent_name: str, event: dict):
        """è®°å½•æ™ºèƒ½ä½“äº‹ä»¶"""
        log_entry = {
            "timestamp": datetime.utcnow().isoformat(),
            "trace_id": event.get("trace_id"),
            "agent_name": agent_name,
            "event_type": event.get("type"),
            "status": event.get("status"),
            "duration_ms": event.get("duration_ms"),
            "data": event.get("data"),
            "error": event.get("error")
        }
        self.write_log(log_entry)
```

### æ—¥å¿—æ•°æ®ç»“æ„

```json
{
  "timestamp": "2025-10-24T21:00:00.123Z",
  "trace_id": "trace_abc123",
  "session_id": "session_def456",
  "agent_name": "DataAgent",
  "event_type": "task_execution",
  "status": "completed",
  "duration_ms": 1500,
  "input": {
    "task": "è·å–é™•è¥¿å»ºå·¥è´¢åŠ¡æ•°æ®",
    "parameters": {...}
  },
  "output": {
    "result": "æ•°æ®è·å–æˆåŠŸ",
    "data_summary": {...}
  },
  "tools_used": ["get_financial_reports", "check_latest_available_report"],
  "error": null,
  "metadata": {
    "workspace": "./stock_analysis_workspace",
    "cache_hit": false
  }
}
```

### è°ƒè¯•åŠŸèƒ½

1. **å®æ—¶æ—¥å¿—**: æµå¼æ˜¾ç¤ºæ‰§è¡Œè¿‡ç¨‹
2. **æ€§èƒ½ç›‘æ§**: è®°å½•æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæ—¶é—´
3. **é”™è¯¯è¿½è¸ª**: è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª
4. **ç»“æœéªŒè¯**: æ£€æŸ¥è¾“å‡ºç»“æœçš„åˆç†æ€§

### è°ƒè¯•å·¥å…·

```python
# æ—¥å¿—åˆ†æè„šæœ¬
python scripts/analyze_orchestra_logs.py --log-file orchestra.log --trace-id trace_abc123

# å®æ—¶ç›‘æ§
python scripts/monitor_orchestra.py --config configs/monitoring.yaml
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### å¹¶è¡Œæ‰§è¡Œ

è™½ç„¶å½“å‰æ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œä½†æ¶æ„æ”¯æŒæœªæ¥çš„å¹¶è¡ŒåŒ–ï¼š

```python
# æœªæ¥å¯èƒ½çš„å¹¶è¡Œæ‰§è¡Œå®ç°
async def execute_parallel(self, tasks: list[Subtask]) -> list[WorkerResult]:
    """å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹çš„ä»»åŠ¡"""
    semaphore = asyncio.Semaphore(self.max_concurrent_tasks)

    async def execute_with_semaphore(task):
        async with semaphore:
            return await self.work(task_recorder, task)

    return await asyncio.gather(*[
        execute_with_semaphore(task) for task in tasks
    ])
```

### ç¼“å­˜æœºåˆ¶

1. **æ•°æ®ç¼“å­˜**: AKShareå·¥å…·çš„æ™ºèƒ½ç¼“å­˜
2. **ç»“æœç¼“å­˜**: ç›¸åŒè¯·æ±‚çš„ç»“æœå¤ç”¨
3. **é…ç½®ç¼“å­˜**: é…ç½®æ–‡ä»¶çš„å†…å­˜ç¼“å­˜

### å†…å­˜ç®¡ç†

1. **ä¸Šä¸‹æ–‡å‹ç¼©**: é™åˆ¶ä¼ é€’çš„ä¸Šä¸‹æ–‡é•¿åº¦
2. **è½¨è¿¹æ¸…ç†**: å®šæœŸæ¸…ç†è¿‡é•¿çš„æ‰§è¡Œè½¨è¿¹
3. **åƒåœ¾å›æ”¶**: åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„å¯¹è±¡

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
import asyncio
from utu.agents import OrchestraAgent

async def main():
    # åˆ›å»ºæ™ºèƒ½ä½“
    config = ConfigLoader.load_agent_config("examples/stock_analysis_final")
    agent = OrchestraAgent(config)
    await agent.build()

    # æ‰§è¡Œä»»åŠ¡
    result = await agent.run("åˆ†æè´µå·èŒ…å°çš„æœ€æ–°è´¢åŠ¡æ•°æ®")
    print(result.final_output)

if __name__ == "__main__":
    asyncio.run(main())
```

### æµå¼è¾“å‡º

```python
# å¯ç”¨æµå¼è¾“å‡º
result_stream = agent.run_streamed("åˆ†æè´µå·èŒ…å°è´¢åŠ¡æ•°æ®")
async for event in result_stream.stream_events():
    print(f"[{event.agent_name}] {event.content}")

# è·å–æœ€ç»ˆç»“æœ
final_output = result_stream.final_output
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é…ç½®åŠ è½½å¤±è´¥**
   - æ£€æŸ¥YAMLæ–‡ä»¶è¯­æ³•
   - éªŒè¯æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤å¿…éœ€çš„ç¯å¢ƒå˜é‡

2. **æ™ºèƒ½ä½“åˆå§‹åŒ–å¤±è´¥**
   - æ£€æŸ¥APIå¯†é’¥é…ç½®
   - éªŒè¯ç½‘ç»œè¿æ¥
   - æŸ¥çœ‹å·¥å…·åŒ…ä¾èµ–

3. **ä»»åŠ¡æ‰§è¡Œè¶…æ—¶**
   - å¢åŠ timeouté…ç½®
   - æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§
   - ä¼˜åŒ–å·¥å…·è°ƒç”¨é€»è¾‘

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**:
   ```python
   import logging
   logging.basicConfig(level=logging.DEBUG)
   ```

2. **ä½¿ç”¨trace_idè·Ÿè¸ª**:
   ```python
   result = await agent.run("åˆ†æä»»åŠ¡", trace_id="debug_123")
   # æ—¥å¿—ä¸­å°†åŒ…å«æ­¤trace_id
   ```

3. **æ£€æŸ¥ä¸­é—´ç»“æœ**:
   ```python
   print(f"è®¡åˆ’: {result.plan}")
   print(f"ä»»åŠ¡è®°å½•: {result.task_records}")
   ```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é…ç½®ç³»ç»Ÿæ–‡æ¡£](./config.md)
- [å·¥å…·åŒ…æ–‡æ¡£](../ref/tool/)
- [æ™ºèƒ½ä½“æ–‡æ¡£](../ref/agents/)
- [æ—¶é—´æ„ŸçŸ¥åŠŸèƒ½](../TIME_AWARE_FIX_SUMMARY.md)

---

*æœ¬æ–‡æ¡£æŒç»­æ›´æ–°ä¸­ï¼Œå¦‚æœ‰é—®é¢˜è¯·æäº¤Issueæˆ–PRã€‚*