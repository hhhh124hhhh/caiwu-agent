#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
测试 save_analysis_result 工具功能
验证AI分析结果能否正确保存到文件
"""

import sys
import os
import json
from pathlib import Path

# 添加项目根目录到Python路径
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from utu.tools.financial_analysis_toolkit import StandardFinancialAnalyzer


def test_save_analysis_result():
    """测试保存分析结果功能"""
    print("=== 测试 save_analysis_result 工具 ===\n")
    
    # 创建分析器实例
    analyzer = StandardFinancialAnalyzer()
    
    # 准备测试数据 - 房地产相邻产业对比分析结果
    analysis_result = """# 房地产相邻产业对比分析 财务分析报告

报告日期: 2025-09-15

## 一、公司概况

公司名称: 房地产相邻产业对比分析

## 二、各产业核心财务指标对比

| 公司 | 行业 | 营业收入(亿元) | 净利润(亿元) | 净利润率 | 资产负债率 | ROE |
|------|------|---------------|-------------|----------|------------|-----|
| **万科A** | 房地产 | 1,053.23 | -108.65 | -10.32% | 73.11% | -3.72% |
| **中国建筑** | 建筑业 | 11,083.07 | 402.74 | 3.63% | 76.27% | 3.77% |
| **海螺水泥** | 建材业 | 412.92 | 43.96 | 10.65% | 20.52% | 2.17% |
| **欧派家居** | 家居装饰 | 82.41 | 10.21 | 12.39% | 48.11% | 5.48% |

## 三、产业特点分析

### 1. 建筑业（中国建筑）
- **规模优势**: 营业收入超万亿，是四者中最大的
- **盈利能力**: 净利润402.74亿元，但净利润率仅3.63%，属于低利润率高周转模式
- **财务杠杆**: 资产负债率76.27%，与万科相当，行业特性决定
- **行业地位**: 作为建筑龙头，相对稳定

### 2. 建材业（海螺水泥）
- **盈利质量**: 净利润率10.65%，在四个行业中最高
- **财务健康**: 资产负债率仅20.52%，财务结构最稳健
- **行业周期**: 受房地产影响较大，但仍保持较好盈利

### 3. 家居装饰业（欧派家居）
- **盈利水平**: 净利润率12.39%，表现优异
- **资本回报**: ROE 5.48%，为四者中最高
- **财务结构**: 资产负债率48.11%，相对合理
- **消费属性**: 偏消费品属性，受房地产周期影响但相对滞后

### 4. 房地产业（万科A）
- **行业困境**: 净利润为负，显示行业面临较大压力
- **高杠杆**: 资产负债率73.11%，财务风险较高
- **转型挑战**: 传统开发模式面临挑战，需寻求新业务增长点

## 四、产业链对比结论

1. **盈利能力排序**: 家居装饰 > 建材 > 建筑 > 房地产
2. **财务稳健性**: 建材 > 家居装饰 > 房地产 > 建筑
3. **规模体量**: 建筑 > 房地产 > 建材 > 家居装饰
4. **受房地产影响程度**: 房地产 > 建筑 > 建材 > 家居装饰

## 五、投资建议

### 对房地产企业的建议
1. **优化债务结构**: 降低资产负债率，控制财务风险
2. **业务转型**: 发展物业管理、租赁住房等轻资产业务
3. **提升运营效率**: 通过数字化转型提高管理效率
4. **多元化发展**: 探索与上下游产业协同发展的新模式

### 对投资者的建议
1. **关注产业链机会**: 建材和家居装饰行业相对稳健，具有投资价值
2. **谨慎对待地产股**: 短期内仍面临较大不确定性
3. **长期布局**: 关注具备转型能力的优质房企
4. **分散投资**: 在房地产产业链上进行合理配置，降低单一行业风险

## 六、风险提示

1. **政策风险**: 房地产调控政策可能继续收紧
2. **市场风险**: 房地产市场需求可能进一步下滑
3. **流动性风险**: 部分房企可能面临资金链紧张问题
4. **行业转型风险**: 传统开发模式向新业务模式转型存在不确定性

---
*本报告基于公开财务数据整理分析，仅供参考，不构成投资建议。投资有风险，入市需谨慎。*"""
    
    # 测试保存分析结果
    print("1. 测试保存分析结果...")
    try:
        result = analyzer.save_analysis_result(
            analysis_result=analysis_result,
            stock_name="房地产相邻产业对比分析",
            file_prefix="./run_workdir"
        )
        print(f"   ✓ {result}")
        
        # 验证文件是否存在
        expected_file = Path("./run_workdir/房地产相邻产业对比分析20250915财务分析报告.md")
        if expected_file.exists():
            print(f"   ✓ 文件已成功创建: {expected_file}")
            print(f"   ✓ 文件大小: {expected_file.stat().st_size} 字节")
        else:
            print(f"   ✗ 文件未找到: {expected_file}")
            
    except Exception as e:
        print(f"   ✗ 保存分析结果时出错: {e}")
        import traceback
        traceback.print_exc()
    
    print("\n=== 测试完成 ===")


if __name__ == "__main__":
    test_save_analysis_result()