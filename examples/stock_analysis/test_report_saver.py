#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
测试报告保存工具功能
验证是否能正确保存各种类型的分析报告
"""

import sys
import os
import json
from pathlib import Path

# 添加项目根目录到Python路径
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

from utu.tools.report_saver_toolkit import ReportSaverToolkit
from utu.config import ToolkitConfig


async def test_report_saver():
    """测试报告保存工具功能"""
    print("=== 测试报告保存工具 ===\n")
    
    # 创建工具实例
    config = ToolkitConfig()
    config.config = {"workspace_root": "./run_workdir"}
    saver = ReportSaverToolkit(config=config)
    
    # 测试数据 - 芯片龙头企业分析报告
    analysis_content = """# 芯片龙头企业财务分析报告

## 执行摘要

本报告分析了国内芯片行业的三家龙头企业：中芯国际、韦尔股份和兆易创新。从财务数据来看，三家公司呈现出不同的特点和发展阶段。

## 公司概况

### 1. 中芯国际（688981）
- **主营业务**: 晶圆代工制造
- **市场地位**: 中国大陆最大、全球前列的晶圆代工厂
- **最新营收**: 323.48亿元
- **最新净利润**: 33.68亿元

### 2. 韦尔股份（603501）
- **主营业务**: 半导体分立器件、电源管理IC等
- **市场地位**: 国内领先的半导体设计公司
- **最新营收**: 139.56亿元
- **最新净利润**: 20.20亿元

### 3. 兆易创新（603986）
- **主营业务**: 存储器、微控制器、传感器
- **市场地位**: 国内存储芯片设计龙头
- **最新营收**: 41.50亿元
- **最新净利润**: 5.88亿元

## 财务指标对比分析

### 营收规模分析
- **中芯国际**: 323.48亿元 - 营收规模最大，体现了晶圆代工行业的重资产特征
- **韦尔股份**: 139.56亿元 - 中等规模，设计公司的典型体量
- **兆易创新**: 41.50亿元 - 相对较小，但专注于细分市场

### 盈利能力分析
- **净利率对比**:
  - 韦尔股份: 14.48%（最高）
  - 兆易创新: 14.16%
  - 中芯国际: 10.41%（最低）

**分析**: 设计公司由于轻资产模式，净利率普遍高于制造公司

### 资产结构分析
- **资产负债率**:
  - 韦尔股份: 38.36%（最高）
  - 中芯国际: 33.78%
  - 兆易创新: 11.94%（最低）

**分析**: 兆易创新财务最为保守，中芯国际和韦尔股份负债水平适中

### 股东回报分析
- **ROE对比**:
  - 韦尔股份: 7.74%（最高）
  - 兆易创新: 3.30%
  - 中芯国际: 0.98%（最低）

**分析**: 韦尔股份为股东创造最好回报，中芯国际ROE偏低主要受重资产模式影响

## 行业特点分析

### 1. 晶圆制造环节（中芯国际）
- **特点**: 重资产、高投入、长周期
- **优势**: 技术壁垒高、市场地位稳固
- **挑战**: 资本密集、盈利周期长

### 2. 芯片设计环节（韦尔股份、兆易创新）
- **特点**: 轻资产、高毛利、快周转
- **优势**: 盈利能力强、现金流好
- **挑战**: 技术更新快、竞争激烈

## 投资价值评估

### 韦尔股份 - 综合表现最佳
- ✅ 净利率最高（14.48%）
- ✅ ROE最高（7.74%）
- ✅ 负债水平适中
- **投资建议**: 值得重点关注

### 兆易创新 - 财务最稳健
- ✅ 资产负债率最低（11.94%）
- ✅ 净利率较高（14.16%）
- ⚠️ 规模相对较小
- **投资建议**: 稳健投资者优选

### 中芯国际 - 战略地位重要
- ✅ 营收规模最大
- ✅ 行业地位突出
- ⚠️ ROE偏低（0.98%）
- ⚠️ 重资产模式
- **投资建议**: 长期战略配置

## 风险提示

1. **行业周期性**: 半导体行业具有强周期性特征
2. **技术迭代**: 技术更新速度快，需持续大额研发投入
3. **地缘政治**: 国际贸易摩擦可能影响供应链
4. **竞争加剧**: 国内外竞争者众多，市场份额争夺激烈

## 投资建议

### 短期策略（1年内）
- 关注韦尔股份，盈利能力强且估值合理
- 关注兆易创新，财务稳健且成长性好

### 长期策略（3-5年）
- 配置中芯国际，享受国产替代红利
- 关注行业整体发展趋势

## 总结

芯片行业作为科技发展的基础产业，具有重要战略意义。三家公司各有特色：
- 中芯国际作为制造龙头，承担国家战略使命
- 韦尔股份在设计领域表现出色，盈利能力强
- 兆易创新专注细分市场，财务结构稳健

投资者可根据风险偏好和投资周期选择合适标的。"""
    
    # 测试保存分析报告
    print("1. 测试保存分析报告...")
    try:
        result = await saver.save_analysis_report(
            content=analysis_content,
            report_name="芯片龙头企业分析",
            file_format="md",
            workspace_dir="./run_workdir"
        )
        print(f"   ✓ {result['message']}")
        if result['success']:
            print(f"   ✓ 文件大小: {result['file_size']} 字节")
    except Exception as e:
        print(f"   ✗ 保存分析报告时出错: {e}")
    
    # 测试数据报告保存
    print("\n2. 测试保存JSON数据报告...")
    try:
        financial_data = {
            "companies": ["中芯国际", "韦尔股份", "兆易创新"],
            "financial_metrics": {
                "revenue": [323.48, 139.56, 41.50],
                "net_profit": [33.68, 20.20, 5.88],
                "net_profit_margin": [10.41, 14.48, 14.16],
                "debt_to_asset_ratio": [33.78, 38.36, 11.94],
                "roe": [0.98, 7.74, 3.30]
            }
        }
        
        result = await saver.save_json_report(
            data=financial_data,
            report_name="芯片企业财务数据",
            workspace_dir="./run_workdir"
        )
        print(f"   ✓ {result['message']}")
        if result['success']:
            print(f"   ✓ 文件大小: {result['file_size']} 字节")
    except Exception as e:
        print(f"   ✗ 保存JSON数据报告时出错: {e}")
    
    # 测试对比报告保存
    print("\n3. 测试保存对比分析报告...")
    try:
        comparison_content = """# 芯片企业对比分析报告

## 对比维度

| 公司 | 营收(亿元) | 净利润(亿元) | 净利率(%) | 资产负债率(%) | ROE(%) |
|------|------------|--------------|-----------|---------------|--------|
| 中芯国际 | 323.48 | 33.68 | 10.41 | 33.78 | 0.98 |
| 韦尔股份 | 139.56 | 20.20 | 14.48 | 38.36 | 7.74 |
| 兆易创新 | 41.50 | 5.88 | 14.16 | 11.94 | 3.30 |

## 分析结论

1. **营收规模**: 中芯国际 > 韦尔股份 > 兆易创新
2. **盈利能力**: 韦尔股份 ≈ 兆易创新 > 中芯国际
3. **财务稳健性**: 兆易创新 > 中芯国际 > 韦尔股份
4. **股东回报**: 韦尔股份 > 兆易创新 > 中芯国际

## 投资建议

- **稳健型投资者**: 推荐兆易创新
- **成长型投资者**: 推荐韦尔股份
- **战略型投资者**: 推荐中芯国际
"""
        
        result = await saver.save_comparison_report(
            content=comparison_content,
            report_name="芯片企业对比分析",
            file_format="md",
            workspace_dir="./run_workdir"
        )
        print(f"   ✓ {result['message']}")
        if result['success']:
            print(f"   ✓ 文件大小: {result['file_size']} 字节")
    except Exception as e:
        print(f"   ✗ 保存对比分析报告时出错: {e}")
    
    print("\n=== 测试完成 ===")


if __name__ == "__main__":
    import asyncio
    asyncio.run(test_report_saver())